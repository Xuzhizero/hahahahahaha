---
title: 舟山测试场仿真部分报告（初稿）
slug: lg2ehsr7ph4q0vig
url: https://www.yuque.com/caogongzi/pu6995/lg2ehsr7ph4q0vig
---

# 概述
## 立项背景
为满足省尖兵项目（大型无人艇自主航行）、海工通用无人运输平台、渔船智能化改造等项目的智能航行及机舱的研发需求，加速通过2026年上半年的CCS认证，浙江省智能船舶研究院有限公司（以下简称“研究院”）在研发方面需着力克服以下几个方面问题：

1. 智能航行算法目前只是依赖理想环境。没有考虑风浪
2. 调试智能航行算法的人力和时间成本高，光是调节实船PID的参数就要一周的时间，日均经济成本接近2万元
3. 新的控制算法如果要验证极端操作情况（例如满舵后再反向满舵），在实船上不方便验证
4. 扩展性暂时没有考虑。 许多额外的装备，比如计程仪，这些架构没有搭载全面。如果要先通过购买实机测试效果和搭载必要性，然后再设计算法，开发周期会大大加长。仿真软件可以轻松添加具备相应功能的扩展模块，例如雷达、深度摄像头，参数均可自行调节
5. 避碰的来船设置、岛礁设置、浅滩设置，大雾大雨天气情况的设置，要么无法实现，要么设置比较麻烦。需要一个成熟的仿真软件很方便的提供这些场景
6. 可视化不够直观。不够直观不仅是给领导汇报的问题，更重要的是，其他组员因为不清楚仿真逻辑，只能依靠仿真效果，不直观的仿真很大程度上会影响其他组员对上下游对接小组的合作的效率，不利于集思广益。
7. 后面涉及到更高级的基于学习的算法，就必须要先在仿真中先经受训练。兵马未动，需要粮草先行。



此外，受舟山市政府委托，研究院承担“智能网联无人艇海上测试场建设方案论证”工作，由于**虚拟测试是可重复、可穷举和多批次的测试，具有低成本和高效率的优点**，因此测试场需要配置虚实融合的船舶仿真测试系统。由此，研究院需要开展虚实融合的船舶仿真测试系统研发，除满足自用外，还可推广到无人船海上测试场及其他相关单位。

## 


## 仿真功能需求汇总
仿真功能应该具备极强的实用性，因此应该紧紧围绕智能航行算法的调试验证需求而制定设计规划。下面对智能航行所各小组的仿真需求进行汇总。按照小组来进行划分，仿真需求列表如下——



| 方面 | 验证算法 | 仿真功能需求 |
| --- | --- | --- |
| 基本需求 |  | 1. 仿真中的物体尺度、空间尺度与实际一致   2. 支持直接导入实船 CAD 图并据此直接得到关键模型参数   3. 能在仿真中添加标识：期望点、期望路径、实际路径   4. 导入真实海洋场景（如舟山海域） |
| 规划与控制 | 循迹算法 | 模拟不同等级、方向的风浪扰动 |
| 规划与控制 | 极端工况下运动控制算法 | 1. 满舵后反向满舵测试（紧急避碰、恶劣海况）   2. 不同风浪等级与方向下船体六自由度抖动/摆动模拟 |
| 规划与控制 | 避碰算法 | 1. 添加随机或预定路径移动的障碍船只/跟踪目标   2. 添加海面与海底障碍（浮筒、岛礁、灯塔），电子围栏具备海底坡度 |
| 规划与控制 | 自主靠泊算法 | 1. 支持多种地形环境：港口、狭窄水域等   2. 不同等级、方向风浪条件下靠泊动作 |
| 感知定位 | 图像视觉增强算法 | 1. 不同光照条件下视觉效果   2. 不同天气条件下视觉效果 |
| 感知定位 | 雷达–视觉融合算法 | 雷达回波仿真及接收    |




表格解释：

+ **“方面”列**：用于对仿真需求进行分类，涵盖了基本平台搭建、规划与控制以及感知定位三大类模块。
+ **“验证算法”列**：标明在该“方面”下所要验证或应用的核心算法类型，比如循迹算法、避碰算法、自主靠泊算法等。
+ **“仿真功能需求”列**：罗列了为了验证某种算法，在仿真环境中必须具备的具体功能，以保证各小组能够针对不同算法或场景进行全面的测试与评估。

## 


# 系统指标
## 定性系统指标
考虑到系统指标定量的困难，目前系统指标暂未定量，但是从定性上说，仿真系统应该要具备：

1. 全面性。动力学仿真模型框架要在搭建伊始就具备涵盖几乎所有海况的理论技术条件
2. 仿真数据易得。仿真模型中的数据方便获得，方便二次处理，方便可视化
3. 传感器高精度。模型中需要加入物理特性高保真的传感器
4. 易扩展。如果未来有新的传感器添加需求，或者有新的动力学模型改进需求（例如将舵-桨驱动方式改成直翼舵桨驱动方式，单个直翼舵桨驱动改成多个直翼舵桨驱动），在模型的更改上需要足够方便
5. 模型递推快速性。由于未来需要纳入多种复杂的海况，因此模型的复杂度在未来一定会很高，因此模型递推的解算速度需要足够快
6. 高保真可视化。为了给感知算法提供高保真的感知背景，环境可视化需要具有较高的保真度
7. 实时性。搭建在不同主机之间的数据沟通需要确保低时延，例如搭载有算法的主机和专门的仿真机之间的数据互通
8. 迭代快速。整个项目工程在缺少人力的前提下，需要能够快速迭代。这一点可以依靠成熟的开源代码、成熟的社区生态等因素支撑
9. 易协同。算法测试人员如果需要仿真，可以方便进行协同仿真，他们为了仿真而额外学习的与仿真部分的内容需要足够少，协同仿真尽可能方便
10. 低成本。采用的方案对经费的开销需要足够小





# 系统总体介绍
## 系统基本组成
### 硬件组成
3台主机，分别用于搭载感知定位算法、规控算法和仿真算法 

### 软件组成
整个系统分为三个主要模块：Ubuntu系统1上跑 ROS 2 算法（主要负责制导、导航、控制），Ubuntu系统2上跑ROS2算法（主要负责和感知定位），Windows 上跑 Simulink（MATLAB）动力学与运动学推演，以及同样在 Windows 上跑 UE5 可视化与传感器仿真。



## 仿真流程
仿真流程图如下图所示：

![仿真流程图](https://cdn.nlark.com/yuque/0/2025/png/2408029/1753324938961-9206d663-6b88-4c7c-856f-c21c8ec29a8c.png)

具体解释如下：

在同一个WIFI子网下，ROS通过 ROS Topic 发出推力/力矩指令给 Simulink，Simulink 递推得到速度和位姿后再同时发回 ROS（给算法验证）和 UE5（更新可视化场景），而 UE5 又能把局部波浪采样结果返传给 Simulink，形成宏观与微观环境的双向耦合。



在 Simulink 中，每个仿真步首先读取来自 ROS 的控制命令，然后将推进力、环境干扰（包括 UE5 返回的粒子采样风速／波速信息）一并带入六自由度动力学模型，求解线速度和角速度并积分得到位姿。Simulink 以高频率跑通这套动力学＋运动学，通过ROS Topic把最新姿态推送给上层算法，也推给 UE5 用于渲染同步。



UE5 方面接收到 Simulink 的位姿和Simulink预先设定的风速、显著波高、波谱类型、地形高度图等宏观参数后，会实时把船体放到三维地形上，利用海面流体材质和粒子特效做到从大尺度波浪到船体周边溅水的高保真渲染，并采集船体周边的局部风浪信息（可能区别于总体的风浪布局）；同时，UE5内置流体插件还可以简易地推演其他“来船”目标的位置轨迹，丰富场景动态。UE5 的传感器插件（激光雷达、摄像头、IMU 等）则在完整场景里读取几何、光照、天气、动态目标等信息，生成点云、图像、惯性测量等原始数据，再返回给 Simulink／ROS，为感知与定位算法提供闭环验证。



这样一来，我们就实现了“ROS→Simulink→UE5→ROS”的端到端仿真链路：算法在智能航行分系统（包含两台Ubuntu主机）上决策，模型递推分系统（以Simulink为主体） 在 Windows 上做高频物理推演，可视化分系统（以UE5为主体） 在同一台机器上做高保真渲染与传感器仿真，并通过粒子采样将局部环境细节回馈给动力学模块。宏观参数驱动大尺度海况，粒子群采样补足微观波浪，最终在多频率、多主机、多模型之间形成一个动态一致、可视可测的自主航行仿真闭环。







##  数据流接口汇总
| 流程环节 | 分系统 | 职责描述 | 数据流入 | 流入来源分系统 | 数据流出 | 流出分系统 |
| --- | --- | --- | --- | --- | --- | --- |
| **环境渲染可视化** | 可视化分系统<br/> | 渲染仿真场景（船体，海面、障碍物、天气） | 船体状态（位置/姿态） | 模型递推分系统 | 场景渲染、视觉传感器视图、环境扰动参数（如波高、风向） | 投屏分系统 |
| **感知元素输入** | | 模拟雷达、AIS电子图传感器，用于障碍信息提取 | 无 | 无 | 点云、图像、惯性测量等原始数据 | 模型递推分系统 |
| **通航情况模拟** | | 渲染并驱动其他水面交通目标（来船）的运动轨迹 | 无 | 无 | 来船信息（如距离、方位、图像等） | 模型递推分系统 |
| **动力学建模与受力解算** | 模型递推分系统 | 计算船体运动状态，解算流体力与姿态变化，保持时间主控 | 外部扰动力（波浪、风）、推进/舵控制指令 | 智能航行算法分系统，可视化分系统 | 船体状态（位置、速度、姿态） | 可视化分系统 |
| **设置参数输出** | | 设置地形数据，设置宏观风浪参数 | 无 | 无 | 地形数据，风浪宏观参数，如风速风向、潮流流速流向、显著波高等 | 可视化分系统 |
| **控制与规划算法实现** | 智能航行算法分系统 | 执行避障、路径规划、运动控制算法 | 船体运动状态 | 模型递推分系统 | 控制指令（推进器/舵角） | 模型递推分系统 |
| **感知定位算法实现** | | 执行图像增强，目标识别，多源传感器数据融合等算法 | 传感器信息（图像，激光雷达点云等） | 模型递推分系统 | 感知信息（如障碍物信息，来船目标信息等） | 智能航行算法分系统 |
| **投屏** | 投屏分系统 | 投屏到大屏幕 | 可视化渲染结果画面 | 可视化分系统 | 无 | 无 |


特别说明：

+ 所有模块均以 Simulink 为**时间主控中心**，通过发布 `/clock` 保持 ROS 2 同步；
+ 控制器、感知与路径算法全部由 ROS 2 实现，以便直接迁移至实船系统；
+ Simulink 通过官方工具箱作为 **桥梁平台**：既负责仿真，也负责转发数据。

## 




# 分系统设计
系统总体可分为智能航行算法分系统，模型递推分系统和可视化分系统，其中智能航行算法分系统的陈述暂略。

## 模型递推分系统
### 与总体的接口
| 流程环节 | 平台/模块 | 职责描述 | 流入数据 | 流入来源分系统/模块 | 流出数据 | 输出分系统/模块 |
| --- | --- | --- | --- | --- | --- | --- |
| 控制指令接收 | 执行机构模型 | 接收 ROS 系统下发的推进器指令，转换为推进力和扭矩 | 螺旋桨转速、矢量推进器方向等控制指令 | ROS系统 | 推进力和力矩 | 船体模型 |
| 地形设置参数输出 | 地形信息设置模块 | 为UE5设置真实地形数据 | 无 | 无 | 地形数据 | UE5 |
| 风、浪宏观参数设置 | 风浪参数设置模块 | 为UE5设置风浪宏观参数  | 无 | 无 | 风浪宏观参数，如风速风向、潮流流速流向、显著波高等 | UE5 |
| 环境干扰计算 | 环境干扰模型 + 解算器 | 根据船体局部采样粒子处的风浪信息计算水动力干扰力和力矩 | UE5 返回的局部环境采样信息 | UE5 | 环境干扰力 & 力矩 | 船体模型 |
| 船体动力学仿真 | 船体模型 + 运动学模型 | 将推进力、干扰力与船体动力学模型耦合，计算六自由度速度并积分得到位姿 | 推进力 & 力矩;   环境干扰力;    | 环境干扰模型、执行机构模型 | 位姿信息  | UE5 |
| 传感器数据采集 | 各类传感器模型 | 收集来自UE5的激光雷达、摄像头、IMU 等多种传感器输出，并将得到的传感器数据发送给 ROS 系统，用于导航、定位和感知算法测试 | 传感器数据 | UE5 | 传感器数据 | ROS系统 |
| 船体真实状态汇总和反馈 | Simulink | 船体真实状态反馈给 ROS，作为智能航行算法的输入 | 船体、环境状态数据 | Simulink、UE5 | 船体、环境状态数据<br/>---------<br/>视场、分辨率、采样频率、噪声模型参数 | ROS系统<br/>--------------<br/>UE5各类传感器 |




### **功能描述**
基于MATLAB&Simulink的 模型分析系统是整个仿真平台的“推递仿真”核心，承担以下主要功能：

1. **推进力和力矩计算**  
在“执行机构模型”中接收来自 ROS 的推进指令（如螺旋桨转速、矢量推进器方向），并转化为对应的推进力和力矩，为动力学计算提供输入。
2. **环境干扰计算**  
通过“环境干扰模型”结合“解算器”，使用风、波宏观参数（及可选的 UE5 局部采样信息）精确地计算附加在船体上的水动力干扰力矩，涵盖波浪冲击、洋流作用等多种海况效应。
3. **船体动力学仿真**  
在“船体模型”中建立六自由度动力学方程，耦合推进与干扰力后求解线速度和角速度，并在“运动学模型”中将速度积分得到实时位姿，完整再现船体在复杂海况下的运动行为。
4. **状态输出**  
将最新的位姿信息实时发送给 UE5，取得高保真的可视化效果；同时将船体真实状态反馈给 ROS，用于算法性能评估和闭环验证。
5. **传感器虚拟化**  
借助“各类传感器模型”，生成仿真激光雷达点云、摄像头图像、IMU 数据等多源传感器输出，为感知与融合算法提供真实感知输入。
6. **统一仿真步长**  
通过锁定仿真步长，保证与 ROS 算法模块和 UE5 可视化模块之间高一致性的数据流通。

### 硬件组成
Win11主机



### 软件模块
Simulink

### 算法描述
动力学建模基于的理论方程：

$ \underbrace{M_{RB}\,\dot\nu \;+\;C_{RB}(\nu)\,\nu \;+\;g(\eta)\;+\;g_0}_{\text{刚体惯性项 + 刚体科氏项 + 静水恢复项 + 压舱恢复项}}
\;+\;
\underbrace{M_A\,\dot\nu_r \;+\;C_A(\nu_r)\,\nu_r \;+\;D(\nu_r)\,\nu_r}_{\text{附加质量惯性 + 附加质量科氏 + 阻尼}}
\;=\;
\tau_{\rm wind} \;+\;\tau_{\rm wave}\;+\;\tau_{\rm thrust} $

并且

$ \nu_r=\nu-\nu_c $



此外，根据“速度等效”原理：当海流是**常量**且**无旋**（irrotational constant current）时，可以在刚体动力学方程里**把所有绝对速度 **$ \nu $ （船体在水下的速度）**换成相对速度 **$ \nu_r $（相对于海流的速度），而**惯性项和科氏项**的形式完全不变。这个变换让我们能**用同一套刚体+水动力模型**，不管船是在静水里、还是在恒定海流里，都只用 $ \nu_r $ 就能跑通全部方程，不必再额外补偿海流带来的附加科氏项，极大地方便了建模和控制系统设计。







## 可视化分系统
### 与总体的接口
| 流程环节 | 平台/模块 | 职责描述 | 数据流入 | 流入来源分系统/模块 | 数据流出 | 输出分系统/模块 |
| --- | --- | --- | --- | --- | --- | --- |
| **位姿同步** | 被控船体 | 接收模型分系统动力学/运动学计算的六自由度位姿，更新船体 对象的位置与朝向 | 船体位姿信息  | 模型分系统 | 无 | 无 |
| **地形渲染** | 三维地形 | 加载并渲染由 Simulink 输出的地形数据 | 地形设置参数 | 模型分系统 | 地形信息 | UE5各类传感器模块 |
| **大尺度海况生成** | 风浪流环境 | 根据宏观环境参数生成海面波浪动态材质与流场模拟 | 风速、风向、显著波高、峰值周期、波谱类型、洋流速度等宏观参数 | 模型分系统 | 风浪信息 | UE5各类传感器模块 |
| **局部风浪信息获取** | 环绕船体粒子群 | 在船体表面及周边布置采样质点，获取采样质点处的具体风浪信息 | 采样质点处的具体风浪信息 | UE5被控船体 | 船体采样点位置；来自“风浪流环境”的波高/波速信息   | Simulink解算器 |
| **场景光照渲染** | 光照／天气系统 | 按照在UE5中设置的光照参数（太阳高度、方位、强度）、天气类型（晴、阴、雨、雾）调整全局光照与气氛效果 | 无 | 无 | 光照、天气信息 | UE5各类传感器模块 |
| **通航情况模拟** | 来船模拟 | 渲染并驱动其他水面交通目标（来船）的运动轨迹，为传感器生成动态物体 | 无 | 无 | 来船信息（如距离、方位、图像等） | UE5各类传感器模块 |
| **传感器仿真** | 各类传感器插件 | 基于完整场景（地形、船体、波浪、来船、光照）生成激光雷达、相机、IMU 等传感器，可以用于采集UE5中渲染场景的信息 | 位姿信息；场景几何与材质；光照／天气状态 | 地形信息<br/>风浪信息<br/>光照、天气信息<br/>来船信息 | 传感器数据 (点云、图像序列、IMU 原始测量等) | Simulink各类传感器模块 |


### 功能描述
基于UE5的可视化分系统是整个仿真平台的“感知与展示”核心，它不仅为物理仿真提供高保真的渲染环境，更承担了关键的传感器仿真职责。具体来说，主要承担以下功能：

1. **场景构建与更新**
    - **地形渲染**：读取 Simulink 提供的地形设置数据（如高度图和网格参数），动态加载与更新海岸线、海床等三维地形。
    - **大尺度海况**：结合风速、显著波高等宏观参数，使用流场模拟插件渲染真实感极强的海面波浪。
    - **局部特效**：在船体周围自动布置采样点，获取船体局部位置的具体海况信息。
2. **动态对象同步**
    - **船体同步**：持续接收主仿真模块的六自由度位姿指令，实时更新船体的位置和姿态，确保物理运动与可视渲染严格一致。
    - **交通目标**：按脚本或算法输入驱动“来船”模型的运动，为协同测试或碰撞场景提供动态干扰。
3. **气氛与光照**
    - 依据光照高度、太阳方位、云量及天气类型（雨、雾等），自动调节全局光照、阴影、天空盒和环境雾效，为图像感知算法提供真实感强的视觉条件。
4. **传感器级仿真**
    - 集成多种传感器插件（激光雷达、立体／鱼眼相机、红外相机、IMU），在完整渲染场景中进行采样，实时生成点云、图像帧和惯性测量数据。
    - 获取来自Simulink定义的各类传感器参数（视场、分辨率、采样频率、噪声模型）



### 硬件组成
Win11

### 软件模块
UE5



# 关键技术
## 动力学&运动学建模（已实现）
递推模型分系统中，需要考虑执行机构，环境干扰，船体模型，以及运动学模型。其中，执行机构部分的仿真会随着驱动方式的变化和执行机构的不同而发生很大的变化。例如基于双直翼舵桨的仿真和基于传统舵-桨亦或者是差速双螺旋桨的仿真一定是大不相同的。总体而言，细节见下图：

![执行机构部分仿真流程图](https://cdn.nlark.com/yuque/0/2025/png/2408029/1753237877674-2bce17dd-12ab-4c8d-b53f-0a887530ef59.png)

这部分功能拟利用simulink官方开源代码（后文简称此官方项目为ASV_Simulink）和海洋系统模拟器（Marine System Simulation, 后文简称MSS）进行开发，因为二者已经封装绝大部分上述功能。ASV_Simulink动力学模型的具体介绍见输入文档《ASV_Simulink》。



ASV_Simulink中，动力学和运动学模型架构如下：

![ASV_Simulink中，动力学和运动学模型架构](https://cdn.nlark.com/yuque/0/2025/png/2408029/1753343008544-c2dfbd13-4c6f-4673-b8b9-0e551ee316f5.png)

首先，“Thrust”模块从 ROS 接收 VesselCommand（推进器转速或矢量推进指令）以及重力常数输入，并基于螺旋桨推力曲线计算出船体的推进力与力矩。接下来，“Waves and Crossflow”模块利用当前相对速度向量 νrν_r、水密度 T 以及六自由度状态，结合交叉流阻力模型，估算波浪和侧向流对船体的附加力和力矩。与此同时，“Hydrodynamics”子模块以阻尼与附加质量矩阵（MA）、重心位置 XX、重力惯性矩 Ig、三轴速度分量 等参数，计算出常规水动力作用下的阻尼力和附加质量效应。最后，“Hydrostatic”（水动力）模块根据船体形心位置 XX 与重心 G，生成恢复力与恢复力矩。

上述四组力和力矩在“Sum of Forces and Moments”汇总后，结合 Inertials（总质量及惯性张量）和 Initial Conditions（初始速度、位置和姿态），送入“6DOF (In CO)”模块。该模块在船体坐标系下对合力和合力矩进行积分，输出线速度 (u,v,w)、角速度 (p,q,r)、位置 (x,y,z)、姿态角 (φ,θ,ψ) 及三轴加速度、角加速度等完整六自由度状态量。最终，“Output Processing”将这些状态变量打包成 VesselStates 总线，供 ROS 算法模块和 UE5 可视化系统订阅使用，从而完成端到端的物理仿真推导与状态传递。



MSS是海洋机器人领域大牛Fossen开发的Simulink库，针对不同类型平台，MSS内置了多自由度（DoF）非线性动力学模型，例如船舶的航向和操纵模型、AUV/USV的6自由度运动模型，这些模型涵盖纵摇、横摇、艏摇等6-DoF运动及相关水动力系数，可用于仿真复杂海况下的运动响应和姿态控制。环境扰动方面，MSS支持仿真外部环境力的影响：通过“Hydro”模块可导入专业水动力软件（如ShipX或WAMIT）的计算结果，施加一阶和二阶波浪力矩，实现船舶在风浪流环境下的时域响应仿真。例如，利用WAMIT/ShipX输出的频域响应函数（RAO），MSS能在Simulink模板中模拟6自由度船舶在规则波和不规则波中的运动。同样地，用户也可以施加恒定流、阵风等干扰，自定义环境模型。MSS还提供了海浪、海流甚至海冰等海洋环境要素的仿真模块。具体对MSS的介绍见输入文档《MSS的chatgpt Deepsearch调研报告》。



ASV_Simulink中的水动力学模块就用到了MSS库，且支持根据我们的需求灵活修改。

## 传感器映射
为了将Simulink中的传感器和UE5中的传感器渲染不仅实现视觉上的匹配，还需要确保UE5中的传感器获得Simulink中的传感器应有的功能，并在二者之间实现数据交互，其中就涉及两个平台之间的“传感器映射”。



在我们的仿真平台中，“传感器映射”关键技术借助 MathWorks Automated Driving Toolbox™ 所提供的 Unreal Engine 场景仿真支持和 Simulink 3D Animation™ 插件实现，将 Simulink 中一系列“Simulation 3D”传感器模块无缝映射到 UE5 场景中的对应 Actor。只要在模型里拖入相机、雷达、激光雷达等模块，背后的 UE5 插件就会自动在虚幻引擎里创建出等效的物理传感器，并把它们实时采集到的图像、点云等数据回推到 Simulink。

![Simulink中的激光雷达模块](https://cdn.nlark.com/yuque/0/2025/png/2408029/1753348716592-d2ea6af6-66b5-4900-9880-94fa1fa9f85e.png)



![Simulink中的摄像头模块](https://cdn.nlark.com/yuque/0/2025/png/2408029/1753348755620-77765643-f6d2-4a30-9f36-1ae969b94d1a.png)

这些映射模块包括常见的针孔相机和鱼眼相机（支持 RGB 图像、深度图与语义分割）、Simulation 3D Lidar（生成高密度激光点云）以及Ultrasonic Sensor（模拟近距测距波束）。更进一步，平台还支持惯性测量单元（IMU）和 GNSS 定位模块的映射，能够提供三轴加速度、角速度、经纬度等真实感十足的测量数据。

## 船体映射（已实现）
在整个仿真闭环中，“船体映射”是将 Simulink 中高频率递推出来的六自由度物理位姿，精确地投射到 UE5 中对应的船体 Actor 上，从而保证物理仿真和可视渲染之间的严格一致。



在我们的仿真平台中，Simulink 借助 Simulink 3D Animation™ 与 Automated Driving Toolbox™ 所提供的 Unreal Engine 接口插件，将“6DOF In CO”输出的位姿总线（位置 + 欧拉角或四元数）通过专用的 Transform Sink 模块，实时推送给 UE5 场景中的船体蓝图（Blueprint）或 Actor 组件。这条从 Simulink 到 UE5 的数据管道支持子系统级别的多体映射，不仅能驱动船体主模型的整体位姿，也能同步更新附着在船体上的螺旋桨、舵机、雷达桅杆等子组件的位置与旋转，使视觉效果与物理状态一一对应。



![UE5中映射得被控船体](https://cdn.nlark.com/yuque/0/2025/png/2408029/1753360730761-ef5e896e-57c8-4051-ac9b-f12190ebb99a.png)

通过“船体映射”，我们得以在 UE5 中直观观察复杂海况下的船舶运动，配合波浪、光照、天气效果以及仿真传感器，完成端到端的可视化验证与调试。无论是调试 LOS+PID 的定点靠泊，还是检验 DWA 在动态障碍下的航线重计划，都可以在画面中同步看到物理模型的真实反馈，极大地提升了算法迭代的效率和仿真结果的可信度。

## 光照/天气条件生成
在自主航行仿真中，光照与天气条件生成能够为视觉与传感器算法提供贴近真实的环境工况，可在晴天、阴天、雨雾等多种场景中验证算法鲁棒性与性能。由于相机在不同光照下的动态范围、阴影投射和反射特性，以及雾雨对激光雷达、毫米波雷达的穿透能力都有显著影响，UE5 中对光照与气象的精细化模拟便成为关乎仿真结果可信度的关键技术。



![UE5中可以实现不同的光照条件](https://cdn.nlark.com/yuque/0/2025/png/2408029/1753361016275-f374e2fe-6afe-47fe-a682-56e303da319b.png)

![UE5中可以实现不同的天气条件](https://cdn.nlark.com/yuque/0/2025/png/2408029/1753360852821-4d3ac7f6-ebb1-421a-a838-9321d334b875.png)

在实现上，我们借助 UE5 内置的 **Sky Atmosphere**、**Directional Light**、**Skylight**、**Exponential Height Fog** 和 **Volumetric Clouds** 组件，结合粒子特效（Particle System）生成降雨、降雪和雾气等动态气象现象。通过蓝图或 C++ 脚本，可以按需调整太阳高度角、云量浓度、雾密度、降水强度和风速方向，甚至模拟昼夜交替或突变天气，为不同算法场景提供多样化的测试用例。

对于视觉传感器，UE5 会在渲染管线中自动计算阴影、镜面反射与散射光，并输出真实感极强的 RGB 图像、深度图和语义分割图；雾效与雨滴粒子还能产生雾散射与水滴遮挡，使得图像识别与跟踪算法在可见度受限时面临真实挑战。对于激光雷达与毫米波雷达，则可通过对 **Exponential Height Fog** 的衰减系数与粒子系统中的液滴分布进行参数化，使回波强度与噪声特性更贴近实测数据。

此外，所有气象参数都支持在仿真过程中动态切换，不必重启场景或重建关卡。这样，开发团队既能批量生成多种天气组合的测试序列，也能在演示或调试时快速切换场景，大大提升了仿真效率和算法验证的全面性。

## 风浪海况条件生成
在自主航行仿真中，“风浪条件生成”承载着将 Simulink 中抽象的宏观风速、显著波高、峰值周期和波浪方向等参数，转化为 UE5 里可视、可交互的真实海面动态的关键环节。只有精确还原不同等级与方向的风浪场景，才能检验控制与避障算法在复杂海况下的鲁棒性，也能让传感器仿真模块捕捉到真实波浪拍击与水花飞溅的细节，从而提高整体仿真可信度。

在实现层面，我们利用 UE5 内置的 Ocean WaterBody 系统与 Gerstner Wave 组件，将从 Simulink 推送过来的风速、显著波高、峰值周期和波浪传播方向实时绑定到多个 Gerstner 波阵列中；同时辅以 Niagara 粒子系统，为船体周边添加局部高频水花与波浪溅射特效，强化视觉与物理反馈。在蓝图或插件脚本中，我们周期性地读取这些宏观参数，并动态更新 WaterBody 的 Wave Amplitude、Wave Length、Wind Direction 等属性，无需重启场景即可切换不同工况。

为了闭环耦合仿真，UE5 还在船体周围布设采样点阵，通过 Scene Capture 或 Niagara Data Interface 获取每个采样点的瞬时波高和局部流速，并将这些微观波浪信息通过同一数据管道返传给 Simulink，用于叠加到动力学模型的环境干扰计算中。借助这种宏观参数驱动与微观粒子采样相结合的方法，“风浪条件生成”不仅在视觉上再现真实海况，更在物理层面为算法提供了与视觉效果匹配的环境输入。

![UE5中呈现的海浪效果](https://cdn.nlark.com/yuque/0/2025/png/2408029/1753360779393-ff00e575-4c75-4050-8ef3-422b75dc5719.png)



## 地形生成
在自主航行仿真中，“地形生成”同样是关键技术之一——只有将真实或拟真海域底形、岸线、岛礁等三维地貌准确地呈现在 UE5 中，才能让动力学模型、传感器仿真和可视化渲染拥有一致的空间参考，保证算法在真实环境中的可迁移性和鲁棒性。

在实现层面，Simulink 会根据用户配置的地形参数（如高度图分辨率、最小/最大坡度、水深范围等），或直接输出经过预处理的高度图文件（RAW/PNG 格式）及三维网格数据，作为外部数据源。UE5 侧则利用内置的 Landscape 系统，将这些高度图导入为地形高度场（Landscape Heightmap），并通过 Layer Paint、Spline 工具等对地表细节进行二次刻画；如果需要导入实船 CAD 以外的地形实体模型，则可使用 Datasmith 插件（或类似的 FBX/OBJ 导入器）将第三方工具（例如从 Google Maps 截图并通过专用插件生成的 FBX 模型）无缝引入到关卡中。

对于从 Google Maps 等数据源截取的地形影像，通常的流程是：先在 GIS 或第三方工具中将影像“贴”到高程网格上，导出为 FBX（或 CAD-compatible 格式），然后使用 UE5 的 Datasmith 导入器一次性将模型及其材质、碰撞体带入场景；也可以直接在 Simulink 端生成灰度高度图（Raw/PNG），在 UE5 编辑器的 Landscape → Import Heightmap 界面中指定分辨率和尺寸，自动创建高度场并应用自定义地形材质。完成后，再结合水体体积（WaterBody）、材质层（Landscape Material）与物理碰撞设置，构建可供物理与传感器模块交互的仿真地形。

![UE5中可以导入不同的地形地貌](https://cdn.nlark.com/yuque/0/2025/png/2408029/1753360814135-e66c1286-4b56-4643-bdd1-8423841fdd2f.png)

如此一来，无论是基于参数化高度图的地形生成，还是第三方 FBX/CAD 模型的导入，UE5 都能以高度一致的方式呈现真实海域环境，为 ASV 自主航行算法提供沉浸式、可交互的仿真场景。



## 多机通信（已实现）
在分布式仿真架构中，多机 ROS 通信是打通 Ubuntu 上的 ROS 2 算法节点与 Windows 上 Simulink 推演模块之间数据流的桥梁——只有在同一 ROS 网络中发布与订阅，才能让算法输出的控制指令准确驱动 Simulink 动力学模型，反过来又能将仿真得到的运动状态实时回传给 ROS，从而构建端到端的闭环验证环境。

要实现这一点，首先需要确保两台主机物理上连入同一局域网，并能相互通信；然后在两端的环境中统一设置 ROS_DOMAIN_ID（ROS 2 域标识符）和 RMW_IMPLEMENTATION（中间件实现）环境变量，使其共享同一个 ROS 网络。接着，在 MATLAB 中搭建 Simulink 模型时，分别插入 ROS 2 Publish 和 ROS 2 Subscribe 块，将要发送或接收的 Topic 名称（如 `/cmd_vel`、`/odom`、`/scan` 等）与对应的消息类型一一对应，并且合理匹配采样周期，保证与对端的发布频率一致。发布时，通过 Blank Message 或自定义信号拼装消息内容；订阅时，通过 Bus Selector 将消息字段分解后接入后续的控制算法或可视化 Scope。

具体到通信参数的配置，可以在 ROS 2 块的属性面板中展开 “Configure ROS 2 Domain ID and RMW” 设置，或者在 MATLAB 命令行中使用 `setenv` 动态指定域 ID 与 RMW 实现，这样即使不运行仿真，也能在 Simulink 环境中列出已连接的 ROS 2 节点。真正启动仿真后，Simulink 会以节点身份向网络发布或订阅话题；在 Ubuntu 终端，使用 `ros2 topic list`、`ros2 topic echo <topic>` 或 `ros2 node list` 即可实时验证消息的收发情况，并在 Simulink 的 Scope 或 Display 中观测到数值跳动。



![多机通信的仿真信号流图](https://cdn.nlark.com/yuque/0/2025/png/2408029/1753360906217-2d61782e-d525-4f37-a3be-7709b3786321.png)

仿真结束时，停止 Simulink 运行便会自动注销对应的 ROS 2 节点与话题，实现清理与复位。通过这一整套方法，多机 ROS 通信不仅保持了跨平台的高度一致性，还让算法与物理推演可以在各自最优的系统环境中并行运行，极大地提升了仿真架构的灵活性和可维护性。

# 总结
本报告围绕省尖兵项目（大型无人艇自主航行）、海工通用无人运输平台及舟山海洋测试场的虚实融合测试需求，阐述了以下内容：

1. **智能航行算法对仿真的功能需求**
    - 需要在仿真中实现常规水流条件下的路径跟踪（APF、LOS + PID），港口/狭窄水域的精准定点与定向（A* + DWA + PID）及动态障碍物环境下的实时避障（DWA），为此需要模拟水流条件、窄水域和动态障碍物
    - 需要支撑不同光照/天气场景下的视觉目标跟踪（YOLO）和雷达–视觉融合仿真
    - 需要完成极端工况测试（满舵反向满舵、六自由度抖动）与各级风浪扰动模拟
2. **端到端闭环架构验证**
    - 通过三台主机（两台 Ubuntu 上运行 ROS 2 算法、Windows 上运行 Simulink 动力学与 UE5 可视化）实现“ROS → Simulink → UE5 → ROS”数据流闭环
    - 仿真的核心在于高保真物理模型（MSS 与 ASV_Simulink）、灵活的传感器映射（利用Simulink的相关 插件），和丰富的地形/光照/气象/海浪条件生成
    - 多机 ROS 通信与无线投屏分系统不仅可保证算法测试与团队协同的高效性，还可保证演示的直观性
3. **预期效益**
    - 显著降低实船 PID 调参的时间成本（以及每日近2万元的经济成本），快速覆盖多场景、多算法的批量验证
    - 为2026年上半年 CCS 认证提供可重复、可穷举的虚拟测试支撑
4. **后续功能升级规划**
    - **完善仿真环境搭建**，在虚拟测试中实现对规控、感知定位算法及执行机构的一站式验证
    - **升级规控算法**，实现侧向水流下的自主循迹与定向靠泊能力
    - **融合视觉与规控**，赋予自主避碰与视觉目标跟踪功能
    - **强化海况适应性**，提升规控算法以应对高强度海况出航需求
    - **扩展感知定位**，结合新型传感器与视觉算法，实现搁浅边界检测，支持狭窄水域及沿岸巡航
    - **优化决策算法**，构建虚拟–实场一体化训练能力，形成闭环迭代的训练与评估体系



# <font style="color:rgb(61, 71, 87);">引用文档</font>
## 输入文档
《ASV_Simulink》

《MSS的chatgpt Deepsearch调研报告》

## 相关标准
暂无。

## 参考资料
1. ASV_simulink官方开源代码：[https://github.com/MartinJXLuo/Simulate-Navigation-Algorithms-of-An-Autonomous-Surface-Vessel-ASV-](https://github.com/MartinJXLuo/Simulate-Navigation-Algorithms-of-An-Autonomous-Surface-Vessel-ASV-)
2. Automated driving box工具箱中，专门用于UE5传感器映射的Simulink 传感器模块汇总：[https://www.mathworks.com/help/driving/ug/choose-a-sensor-for-3d-simulation.html](https://www.mathworks.com/help/driving/ug/choose-a-sensor-for-3d-simulation.html)
3. MSS Github 网址：[https://github.com/cybergalactic/MSS/blob/master/MSS%20Quick%20Reference.md#marine-craft-simulators](https://github.com/cybergalactic/MSS/blob/master/MSS%20Quick%20Reference.md#marine-craft-simulators)







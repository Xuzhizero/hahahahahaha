---
title: 技术报告V1
slug: xb1p8wv43lvxx1ei
url: https://www.yuque.com/caogongzi/pu6995/xb1p8wv43lvxx1ei
---

# 概述
## 项目背景
转正期间做了三个方面的工作，首先是对仿真动力学模型进行优化，然后是基于ROS2的导航规划，第三是基于UE5的仿真可视化。这三个工作是存在先后逻辑关系的，它们从建模到导航再到可视化，形成一个比较完整的仿真框架。



## 项目目标
从建模到导航再到可视化，形成一个比较完整的仿真框架。具体包括：

1. 动力学&运动学建模
2. 舵角变化的效果展示
3. 实现静水中的定向定点
4. 仿真可视化

## 设计原则
软件使用开源的产品。  
①　操作系统采用Linux系统，Ubantu 22.04版本；  
②　编程语言使用 Matlab和Python3.11；  
③　使用开源的ROS2构建自主航行系统的软件架构。



考虑到系统指标定量的困难，目前系统指标暂未定量，但是从定性上说，仿真系统应该要具备：

1. 全面性。动力学仿真模型框架要在搭建伊始就具备涵盖几乎所有海况的理论技术条件
2. 仿真数据易得。仿真模型中的数据方便获得，方便二次处理，方便可视化
3. 传感器高精度。模型中需要加入物理特性高保真的传感器
4. 易扩展。如果未来有新的传感器添加需求，或者有新的动力学模型改进需求（例如将舵-桨驱动方式改成直翼舵桨驱动方式，单个直翼舵桨驱动改成多个直翼舵桨驱动），在模型的更改上需要足够方便
5. 模型递推快速性。由于未来需要纳入多种复杂的海况，因此模型的复杂度在未来一定会很高，因此模型递推的解算速度需要足够快
6. 高保真可视化。为了给感知算法提供高保真的感知背景，环境可视化需要具有较高的保真度
7. 实时性。搭建在不同主机之间的数据沟通需要确保低时延，例如搭载有算法的主机和专门的仿真机之间的数据互通
8. 迭代快速。整个项目工程在缺少人力的前提下，需要能够快速迭代。这一点可以依靠成熟的开源代码、成熟的社区生态等因素支撑
9. 易协同。算法测试人员如果需要仿真，可以方便进行协同仿真，他们为了仿真而额外学习的与仿真部分的内容需要足够少，协同仿真尽可能方便
10. 低成本。采用的方案对经费的开销需要足够小

## 预期成果
形成一个比较完整的仿真框架，为后续进一步深入仿真工作，加速推进仿真实验室建设奠定基础。



# 系统总体设计
## 设计思路
下面简要介绍一下整体的信号流动过程（见下图）：

![仿真信号流](https://cdn.nlark.com/yuque/0/2025/png/2408029/1753782406206-ed23b1d4-81a0-4e56-8a85-eb938b597a38.png)

首先，每次被控船只的状态经过动力学方程更新以后，位于Ubuntu系统的ROS2会将船只的位姿信息发布，然后，位于Windows但处于同一个局域网下的Simulink会通过ROS2Simulink模块订阅位姿信息，最后再用Simulink2UE5模块发送给UE5中的舰船对象，改变舰船在UE5中的位置和姿态。UE5也同样位于Windows系统。

## 硬件/软件考虑
### 硬件组成
暂时只用一台主机。

### 软件组成
整个系统分为三个主要模块：Ubuntu系统上跑 ROS 2 算法（主要负责制导、导航、控制）以及动力学递推，Windows  上跑 Simulink（MATLAB）作为链接ROS2和UE5的桥梁，以及同样在 Windows 上跑 UE5 可视化。



具体环境配置：

Ubuntu 22.04

Python 3.11

<font style="color:rgba(0, 0, 0, 0.75);">ROS2 Humble</font>

<font style="color:rgba(0, 0, 0, 0.75);">MATLAB 2024b</font>

<font style="color:rgba(0, 0, 0, 0.75);">UE版本 5.3.2</font>



# 递推模型分系统设计
下面首先介绍一下递推模型分系统（主要包括动力学模型和运动学模型）优化方面的工作

## 功能描述
动力学&运动学建模分系统是整个仿真平台的“推递仿真”核心，承担以下主要功能：

1. **推进力和力矩计算**  
接收来自 Simulink的推进指令（如螺旋桨转速、矢量推进器方向），并转化为对应的推进力和力矩，为动力学计算提供输入。
2. **环境干扰计算**  
计算附加在船体上的水动力干扰力矩，涵盖波浪冲击、洋流作用等多种海况效应。
3. **船体动力学仿真**  
在“船体模型”中建立六自由度动力学方程，耦合推进与干扰力后求解线速度和角速度，并在“运动学模型”中将速度积分得到实时位姿，完整再现船体在复杂海况下的运动行为。
4. **状态输出**  
将最新的位姿信息实时发送给 Simulink，取得高保真的可视化效果

## 算法实现
### 利用递推公式实现动力学建模
目前我们采用的仿真动力学模型，是一阶K-T模型，它建立了船舶舵角到角速度之间的映射关系，船舶舵角与角速度之间的一阶K-T方程：

![](https://cdn.nlark.com/yuque/0/2025/png/2408029/1753781006500-0bfb8509-dc02-4fde-aec3-7c2d3cc315f5.png)

然而，K-T方程中的时间常数和回转型指数都是常数，而实际上它们的取值是与船体航行的线速度密切相关的，因此，K-T方程成立的基本前提，是船体处于匀速的运动状态下。但是从船舶启航到船舶停泊，整个过程中必定涉及加速、减速、慢速行驶、快速行进等情况，我们的实际经验告诉我们，这些不同的情况下，同样的舵角引起的角速度显然是大不一样的。因此，如果要让仿真动力学模型更加符合实际的情况，就至少需要将航行速度对转动角速度的影响考虑进去。考虑速度的影响，实际应为：

![](https://cdn.nlark.com/yuque/0/2025/png/2408029/1753781031104-c889dfcc-5ce9-49aa-b543-8f683b8b297d.png)



其中：

![](https://cdn.nlark.com/yuque/0/2025/png/2408029/1753781150849-97803780-8972-4b1a-910c-be690ddf3b7c.png)





打舵时，船体不同的航行速度之所以会影响转向效果，原因可以从下面公式（1）中看出：

![](https://cdn.nlark.com/yuque/0/2025/png/2408029/1753781271759-dfba2b6c-eecd-489d-90ee-d2f1a1e8bdda.png)

公式来源：Whicker, L.F. & Fehlner, L.F. (1958). 《Free-stream characteristics of a family of low-aspect-ratio, all-movable control surfaces for application to ship design》。公式（1）反映的是，流体施加在船舵上的力矩与舵角的关系，各量含义解释如下：

![](https://cdn.nlark.com/yuque/0/2025/png/2408029/1753781359636-11fd2173-093b-4662-b40f-7e46c7844002.png)

可以看到关系式中是存在航行速度的平方项的。此外还可以看到，关系式中法向力系数是关于舵角的函数。对其在舵角为0处做泰勒展开，展开式的形式如下图所示：

![](https://cdn.nlark.com/yuque/0/2025/png/2408029/1753781412063-868bb722-3594-4f9a-89c1-a9f1a9123a5a.png)

由于密度、舵面积和舵到重心的距离都近似为常数，将所有的常数项合并，取前两项，常数项系数分别统称为K1和K2，就可以得到红框中这条公式：

![](https://cdn.nlark.com/yuque/0/2025/png/2408029/1753781452596-56ffbce2-0a10-4acc-9513-f955159572d3.png)

由于船体存在转动惯量，因此力矩会对船体产生角加速度，进而形成角速度，如下边公式（2）所示：

![](https://cdn.nlark.com/yuque/0/2025/png/2408029/1753781485690-c5d1abbe-d0ca-40cb-acf3-f3b9a9b804e4.png)

公式中各量解释如下所示：

![](https://cdn.nlark.com/yuque/0/2025/png/2408029/1753781656376-f0799701-cb25-4dd5-8412-309933b9e5a2.png)

通过将舵角到角速度的映射关系解耦为方程（1）和方程（2），就可以更有针对性的对仿真动力学模型进行优化。之后的工作内容，都是基于这种解耦的转向动力学模型。如果不使用滑模控制、反步法这类基于模型的控制策略，那么动力学模型是仅用于仿真，那么K1和K2只需要通过手动调参让船在仿真中的移动情况符合现实的转向情况即可，并不需要通过实验专门进行辨识。



改进的仿真动力学模型框图如图所示：

![改进后的转向动力学模型框图](https://cdn.nlark.com/yuque/0/2025/png/2408029/1753781749149-80a9190d-814e-4519-8e23-657bfce86145.png)

在仿真过程中，首先接收舵角和航行速度信息，映射为力矩以后，再用龙格库塔法递推力矩和角速度之间的微分方程并作积分得到最后的航向角。

### 加入舵角控制后的效果展示
下面的截图分别展示了俯视视角下，舵角的控制效果和舵角引起的航向变化：

![无打舵时的情况](https://cdn.nlark.com/yuque/0/2025/png/2408029/1753781837372-e26eb613-9c99-438c-be6c-3c946becf51e.png)![打舵后的情况](https://cdn.nlark.com/yuque/0/2025/png/2408029/1753781887967-25974df8-5ba4-4181-a188-c5f143ce68a9.png)

![舵角变化引起航向变化效果展示（键盘控制舵角和推进）](https://cdn.nlark.com/yuque/0/2025/png/2408029/1753781974346-e029b6f0-8790-4450-9799-2749fce326c0.png)

其中球体代表了船只，白色的细杆代表船只的艏向，球体顶部的黑色细板代表了船舵，为了更容易看清楚舵角的变化，目前设置左右满舵的舵角为60度。右侧视频可以看到，在高速行进时，满舵舵角引起的转向响应速度相较于在低速行进的情况更为灵敏。目前螺旋桨的转速对应到航速上还是依赖线性映射，做了一个基于转动动力学方程的模型，还没有投入应用。转动动力学方程如下所示：

![](https://cdn.nlark.com/yuque/0/2025/png/2408029/1753781939145-66cfd7ce-181b-40fc-b305-07a74395e76c.png)





### 利用Simulink的MSS库实现动力学&运动学建模
递推模型分系统中，需要考虑执行机构，环境干扰，船体模型，以及运动学模型。其中，执行机构部分的仿真会随着驱动方式的变化和执行机构的不同而发生很大的变化。例如基于双直翼舵桨的仿真和基于传统舵-桨亦或者是差速双螺旋桨的仿真一定是大不相同的。总体而言，细节见下图：

![执行机构部分仿真流程图](https://cdn.nlark.com/yuque/0/2025/png/2408029/1753237877674-2bce17dd-12ab-4c8d-b53f-0a887530ef59.png)

这部分功能拟利用simulink官方开源代码（后文简称此官方项目为ASV_Simulink）和海洋系统模拟器（Marine System Simulation, 后文简称MSS）进行开发，因为二者已经封装绝大部分上述功能。



ASV_Simulink中，动力学和运动学模型架构如下：

![ASV_Simulink中，动力学和运动学模型架构](https://cdn.nlark.com/yuque/0/2025/png/2408029/1753343008544-c2dfbd13-4c6f-4673-b8b9-0e551ee316f5.png)

首先，“Thrust”模块从 ROS 接收 VesselCommand（推进器转速或矢量推进指令）以及重力常数输入，并基于螺旋桨推力曲线计算出船体的推进力与力矩。接下来，“Waves and Crossflow”模块利用当前相对速度向量 νrν_r、水密度 T 以及六自由度状态，结合交叉流阻力模型，估算波浪和侧向流对船体的附加力和力矩。与此同时，“Hydrodynamics”子模块以阻尼与附加质量矩阵（MA）、重心位置 XX、重力惯性矩 Ig、三轴速度分量 等参数，计算出常规水动力作用下的阻尼力和附加质量效应。最后，“Hydrostatic”（水动力）模块根据船体形心位置 XX 与重心 G，生成恢复力与恢复力矩。



上述四组力和力矩在“Sum of Forces and Moments”汇总后，结合 Inertials（总质量及惯性张量）和 Initial Conditions（初始速度、位置和姿态），送入“6DOF (In CO)”模块。该模块在船体坐标系下对合力和合力矩进行积分，输出线速度 (u,v,w)、角速度 (p,q,r)、位置 (x,y,z)、姿态角 (φ,θ,ψ) 及三轴加速度、角加速度等完整六自由度状态量。最终，“Output Processing”将这些状态变量打包成 VesselStates 总线，供 ROS 算法模块和 UE5 可视化系统订阅使用，从而完成端到端的物理仿真推导与状态传递。



MSS是海洋机器人领域大牛Fossen开发的Simulink库，针对不同类型平台，MSS内置了多自由度（DoF）非线性动力学模型，例如船舶的航向和操纵模型、AUV/USV的6自由度运动模型，这些模型涵盖纵摇、横摇、艏摇等6-DoF运动及相关水动力系数，可用于仿真复杂海况下的运动响应和姿态控制。环境扰动方面，MSS支持仿真外部环境力的影响：通过“Hydro”模块可导入专业水动力软件（如ShipX或WAMIT）的计算结果，施加一阶和二阶波浪力矩，实现船舶在风浪流环境下的时域响应仿真。例如，利用WAMIT/ShipX输出的频域响应函数（RAO），MSS能在Simulink模板中模拟6自由度船舶在规则波和不规则波中的运动。同样地，用户也可以施加恒定流、阵风等干扰，自定义环境模型。MSS还提供了海浪、海流甚至海冰等海洋环境要素的仿真模块。具体对MSS的介绍见输入文档《MSS的chatgpt Deepsearch调研报告》。



ASV_Simulink中的水动力学模块就用到了MSS库，且支持根据我们的需求灵活修改。





# 基于ROS2的导航规划分系统设计
## 功能描述
用于实现导航规划方面的功能，包括路径规划，运动控制。

## 具体实现
下面介绍基于ROS2的导航规划方面工作。首先介绍一下Navigation 2 这个开源的机器人导航框架。下图展示的是框架的内部结构：

![ROS2的Navigation系统框架](https://cdn.nlark.com/yuque/0/2025/png/2408029/1753782139547-13426603-d59d-4898-84e8-4aa8b29024bc.png)

可以看到它由导航服务器、恢复器服务器、控制器服务器和规划器服务器四大服务器组成，除了导航服务器，每个服务器中都内置多种不同算法，以规划器服务器为例，内置了经过改进的混合A星、Dijkstra和DWA算法，规划器服务器可以根据配置加载不同的规划算法完成规划任务。我们可以通过直接启动Navigation框架中的launch文件实现单点或多点的导航、动态避障等功能。相比起一般的开源导航算法，Navigation最大的特点在于，第一，自带恢复器服务器，内置多种脱困算法，可以实现机器人的自主脱困；第二，自带行为树导航服务器，它可以根据XML行为树描述文件，自行决定在什么处境下调用恢复器、控制器还是规划器，从而完成对机器人的行为控制，这种设计的优势在于，导航的复杂逻辑被清晰地写在XML文件中，而不是硬编码在程序中。如果你想改变机器人的导航策略，只需要修改XML文件，而不需要针对程序本身进行改写。因此这种机制可以大幅提升开发效率。第三，Navigation导航框架作为一个生态，支持插件，除了官方的算法，我们可以很方便通过编译和配置将第三方的机器人算法插件集成到我们自己的系统中。



考虑到ROS2的Navigation导航框架已经很完备，因此我在它的基础上比较快速地实现了静水中的定点效果。但是由于时间有限，我暂时使用的是以前已经做好的差速驱动模型，导航过程效果如下图所示：

![定点效果展示（提供目标位姿）](https://cdn.nlark.com/yuque/0/2025/png/2408029/1753782235664-45dfc048-8550-4b66-8c19-cac46289f4a3.png)

![定点效果展示（跟随规划路径期间的运动过程）](https://cdn.nlark.com/yuque/0/2025/png/2408029/1753782263446-f8c5d894-ad59-4087-a96b-442b65995aaf.png)

整体的导航控制框图如下图所示：

![导航控制框图](https://cdn.nlark.com/yuque/0/2025/png/2408029/1753782191339-7bd82f06-b351-47b7-ace5-de8586aa49f0.png)

在给予期望位姿以后，先后经过A星的全局路径规划和DWA的局部路径规划，然后输出期望的线速度和角速度，分别经过各自的PID控制器，输出期望力矩和推力后，经过推力分配单元，输出左右螺旋桨的pwm数值，驱动被控船只改变其位姿，逐渐趋向目标位姿。框图中的A星算法和DWA算法直接来源于Navigation框架，其中DWA自带动态避障的能力。







# 基于UE5的仿真可视化分系统设计
## 功能描述
基于UE5的可视化分系统是整个仿真平台的“感知与展示”核心，它不仅为物理仿真提供高保真的渲染环境，更承担了关键的传感器仿真职责。具体来说，主要承担以下功能：

1. **场景构建与更新**
    - **地形渲染**：读取 Simulink 提供的地形设置数据（如高度图和网格参数），动态加载与更新海岸线、海床等三维地形。
    - **大尺度海况**：结合风速、显著波高等宏观参数，使用流场模拟插件渲染真实感极强的海面波浪。
    - **局部特效**：在船体周围自动布置采样点，获取船体局部位置的具体海况信息。
2. **动态对象同步**
    - **船体同步**：持续接收主仿真模块的六自由度位姿指令，实时更新船体的位置和姿态，确保物理运动与可视渲染严格一致。
    - **交通目标**：按脚本或算法输入驱动“来船”模型的运动，为协同测试或碰撞场景提供动态干扰。
3. **气氛与光照**
    - 依据光照高度、太阳方位、云量及天气类型（雨、雾等），自动调节全局光照、阴影、天空盒和环境雾效，为图像感知算法提供真实感强的视觉条件。
4. **传感器级仿真**
    - 集成多种传感器插件（激光雷达、立体／鱼眼相机、红外相机、IMU），在完整渲染场景中进行采样，实时生成点云、图像帧和惯性测量数据。
    - 获取来自Simulink定义的各类传感器参数（视场、分辨率、采样频率、噪声模型）



## 具体实现


下面两图展示了在Ubuntu系统中用键盘操控船只的舵角和推进速度，然后从发布ROS2话题，最后到位姿信息应用在UE5舰船上的整个过程：

![仿真全流程效果展示图1](https://cdn.nlark.com/yuque/0/2025/png/2408029/1753782478697-d1ba59e4-3420-4271-834e-b404c943a228.png)

![仿真全流程效果展示图2](https://cdn.nlark.com/yuque/0/2025/png/2408029/1753782501136-cbd35b58-524a-4273-aca7-608d3101c666.png)



导航流程：

![](https://cdn.nlark.com/yuque/0/2025/png/2408029/1753782628175-c24a1bf1-6d3f-4ea4-97e5-93139b8ae699.png)






